<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Resultados</title>
  <link rel="stylesheet" href="index_style.css" />
  <style>
    #start-btn, #next-btn {
      margin-top: 20px;
      font-size: 22px;
      padding: 12px 25px;
      background-color: #4db6ac;
      color: white;
      border: none;
      border-radius: 12px;
      cursor: pointer;
    }
    #countdown {
      font-size: 40px;
      color: white;
      margin-top: 20px;
    }
    #bar-container {
      margin-top: 30px;
    }
    .bar {
      height: 30px;
      margin: 10px auto;
      background-color: #26a69a;
      color: white;
      text-align: left;
      padding-left: 10px;
      border-radius: 10px;
      font-weight: bold;
    }

    #connected-count {
  font-size: 22px;
  font-weight: bold;
  color: #ffffff;
  background: rgba(0, 150, 136, 0.8);
  padding: 12px 20px;
  border-radius: 10px;
  display: inline-block;
  margin-top: 20px;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
}

    #results-container {
  margin-top: 40px;
  background-color: rgba(255, 255, 255, 0.85);
  border-radius: 20px;
  padding: 20px;
  max-width: 700px;
  margin-left: auto;
  margin-right: auto;
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
}
  </style>
</head>
<body>
  <h1>Panel del Host</h1>
  <div id="connected-count">Conectados: 0</div>
  <div id="question-text">Esperando a comenzar…</div>
  <button id="start-btn">Iniciar Encuesta</button>
  <div id="countdown"></div>
  <div id="results-container"></div>
  <button id="next-btn" style="display:none">Siguiente Pregunta</button>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
    import { getDatabase, ref, onValue, set, runTransaction } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCsYSsb-PsxTCKihp7ROVJsdBSFX3dMd2w",
      authDomain: "poll-e8e49.firebaseapp.com",
      databaseURL: "https://poll-e8e49-default-rtdb.firebaseio.com",
      projectId: "poll-e8e49",
      storageBucket: "poll-e8e49.firebasestorage.app",
      messagingSenderId: "957719245646",
      appId: "1:957719245646:web:490403f5587901efcde41f"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const startBtn = document.getElementById("start-btn");
    const nextBtn = document.getElementById("next-btn");
    const questionText = document.getElementById("question-text");
    const countdownEl = document.getElementById("countdown");
    const barContainer = document.getElementById("bar-container");
    const connectedCountEl = document.getElementById("connected-count");

    const questions = [
      { question: "¿Cuál es tu color favorito?", options: ["Rojo", "Azul", "Verde", "Amarillo"] },
      { question: "¿Cuál es tu animal favorito?", options: ["Perro", "Gato", "Pez", "Pájaro"] },
      { question: "¿Cuál es tu estación favorita?", options: ["Verano", "Invierno", "Otoño", "Primavera"] },
    ];

    let current = 0;

    // Mostrar cantidad de conectados
    const connectedRef = ref(db, "connectedUsers");

onValue(connectedRef, (snapshot) => {
  const count = snapshot.size || Object.keys(snapshot.val() || {}).length;
  document.getElementById("connected-count").textContent = `Conectados: ${count}`;
});
    // Iniciar encuesta
    startBtn.onclick = () => {
      set(ref(db, "state"), { status: "active", current: 0 });
      startBtn.style.display = "none";
      mostrarCuentaRegresivaYResultados();
    };

    nextBtn.onclick = () => {
      current++;
      if (current < questions.length) {
        set(ref(db, "state"), { status: "active", current });
        mostrarCuentaRegresivaYResultados();
      } else {
        set(ref(db, "state"), { status: "finished" });
        questionText.textContent = "Encuesta finalizada.";
        countdownEl.textContent = "";
        barContainer.innerHTML = "";
        nextBtn.style.display = "none";
      }
    };

    function mostrarCuentaRegresivaYResultados() {
      const q = questions[current];
      questionText.textContent = q.question;
      barContainer.innerHTML = "";
      countdownEl.textContent = "5";
      let count = 5;
      const timer = setInterval(() => {
        count--;
        countdownEl.textContent = count;
        if (count === 0) {
          clearInterval(timer);
          countdownEl.textContent = "";
          mostrarResultados(q.options);
          nextBtn.style.display = "inline-block";
        }
      }, 1000);
    }

    function mostrarResultados(options) {
      const qKey = `q${current}`;
      onValue(ref(db, `votes/${qKey}`), (snap) => {
        const data = snap.val() || {};
        const total = Object.values(data).reduce((a, b) => a + b, 0) || 1;
        barContainer.innerHTML = "";

        options.forEach((opt) => {
          const val = data[opt] || 0;
          const pct = ((val / total) * 100).toFixed(1);
          const bar = document.createElement("div");
          bar.className = "bar";
          bar.style.width = pct + "%";
          bar.textContent = `${opt} (${pct}%)`;
          barContainer.appendChild(bar);
        });
      }, { onlyOnce: true });
    }
  </script>
</body>
</html>
