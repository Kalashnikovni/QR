<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Resultados</title>
  <link rel="stylesheet" href="estilos.css" />
  <style>
    #connected-count {
      font-size: 20px;
      color: #fff;
      background: rgba(0, 0, 0, 0.3);
      padding: 10px;
      border-radius: 10px;
      display: inline-block;
      margin-top: 20px;
    }
    #bar-container {
      margin: 40px auto;
      max-width: 600px;
      background: #ffffffcc;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 8px 16px rgba(0,0,0,0.15);
    }
    .bar {
      height: 40px;
      background-color: #4db6ac;
      margin: 10px 0;
      color: white;
      line-height: 40px;
      padding-left: 10px;
      border-radius: 8px;
      text-align: left;
    }
  </style>
</head>
<body>
  <h1>Panel del Host</h1>
  <div id="connected-count">Conectados: 0</div>
  <button id="start-btn">Iniciar encuesta</button>
  <div id="countdown" style="font-size: 36px; margin-top: 20px;"></div>
  <div id="bar-container"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
    import { getDatabase, ref, onValue, set } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-database.js";

    const app = initializeApp({
      apiKey: "AIzaSyCsYSsb-PsxTCKihp7ROVJsdBSFX3dMd2w",
      authDomain: "poll-e8e49.firebaseapp.com",
      databaseURL: "https://poll-e8e49-default-rtdb.firebaseio.com",
      projectId: "poll-e8e49",
      storageBucket: "poll-e8e49.appspot.com",
      messagingSenderId: "957719245646",
      appId: "1:957719245646:web:490403f5587901efcde41f"
    });

    const db = getDatabase(app);

    const connectedCount = document.getElementById("connected-count");
    const countdown = document.getElementById("countdown");
    const barContainer = document.getElementById("bar-container");
    const startBtn = document.getElementById("start-btn");

    // Escuchar cantidad de conectados
    const connRef = ref(db, "connections");
    onValue(connRef, snap => {
      const count = snap.val() || 0;
      connectedCount.textContent = `Conectados: ${count}`;
    });

    const question = {
      question: "¿Cuál es tu fruta favorita?",
      options: ["Manzana", "Banana", "Naranja", "Pera"]
    };

    startBtn.onclick = () => {
      set(ref(db, "votes"), {});
      set(ref(db, "currentQuestion"), question);
      countdown.textContent = "5";
      let time = 5;
      const interval = setInterval(() => {
        time--;
        if (time > 0) {
          countdown.textContent = time;
        } else {
          clearInterval(interval);
          countdown.textContent = "Resultados:";
          showResults();
        }
      }, 1000);
    };

    function showResults() {
      const votesRef = ref(db, "votes");
      onValue(votesRef, snap => {
        const votes = snap.val() || {};
        barContainer.innerHTML = "";
        question.options.forEach(opt => {
          const val = votes[opt] || 0;
          const div = document.createElement("div");
          div.className = "bar";
          div.style.width = `${10 + val * 10}px`;
          div.textContent = `${opt}: ${val}`;
          barContainer.appendChild(div);
        });
      });
    }
  </script>
</body>
</html>
