<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Encuesta en Vivo</title>
  <style>
    body {
      background: #f3f4f6;
      font-family: 'Segoe UI', sans-serif;
      color: #111827;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 2rem;
    }

    .card {
      background: white;
      border-radius: 1rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      padding: 2rem;
      max-width: 600px;
      width: 100%;
      margin-bottom: 2rem;
    }

    h2 {
      font-size: 1.5rem;
      margin-bottom: 1rem;
      text-align: center;
    }

    .option {
      background: #e5e7eb;
      padding: 0.75rem 1rem;
      border-radius: 0.75rem;
      margin: 0.5rem 0;
      cursor: pointer;
      transition: 0.2s ease;
    }

    .option:hover {
      background: #d1d5db;
    }

    .option.disabled {
      pointer-events: none;
      opacity: 0.6;
    }

    .bar-container {
      background: #e5e7eb;
      border-radius: 0.5rem;
      overflow: hidden;
      height: 1.2rem;
      margin-top: 0.3rem;
    }

    .bar {
      height: 100%;
      background: #60a5fa;
      transition: width 0.4s ease;
    }

    .next-btn {
      margin-top: 1.5rem;
      padding: 0.75rem 1.5rem;
      background: #3b82f6;
      color: white;
      border: none;
      border-radius: 0.5rem;
      cursor: pointer;
      display: none;
    }

    .next-btn:hover {
      background: #2563eb;
    }
  </style>
</head>
<body>
  <div class="card">
    <h2 id="question">Cargando pregunta...</h2>
    <div id="options"></div>
    <button id="nextBtn" class="next-btn">Siguiente</button>
  </div>

  <!-- Firebase scripts -->
  <script type="module">
    //import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
    import { getDatabase, ref, push, onValue, increment, update, get, child } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-database.js";

    // ðŸ”§ ReemplazÃ¡ esto con tu config real
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "firebase/app";
    // TODO: Add SDKs for Firebase products that you want to use
    // https://firebase.google.com/docs/web/setup#available-libraries

    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCsYSsb-PsxTCKihp7ROVJsdBSFX3dMd2w",
      authDomain: "poll-e8e49.firebaseapp.com",
      databaseURL: "https://poll-e8e49-default-rtdb.firebaseio.com",
      projectId: "poll-e8e49",
      storageBucket: "poll-e8e49.firebasestorage.app",
      messagingSenderId: "957719245646",
      appId: "1:957719245646:web:490403f5587901efcde41f"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const questions = [
      {
        text: "Â¿CuÃ¡l es tu color favorito?",
        options: ["Rojo", "Azul", "Verde", "Amarillo"]
      },
      {
        text: "Â¿CuÃ¡l es tu animal favorito?",
        options: ["Perro", "Gato", "Pez", "PÃ¡jaro"]
      },
      {
        text: "Â¿QuÃ© estaciÃ³n preferÃ­s?",
        options: ["Verano", "Invierno", "OtoÃ±o", "Primavera"]
      }
    ];

    let current = 0;

    const questionEl = document.getElementById("question");
    const optionsEl = document.getElementById("options");
    const nextBtn = document.getElementById("nextBtn");

    function loadQuestion() {
      const q = questions[current];
      questionEl.textContent = q.text;
      optionsEl.innerHTML = "";
      nextBtn.style.display = "none";

      q.options.forEach((opt, idx) => {
        const div = document.createElement("div");
        div.className = "option";
        div.textContent = opt;
        div.onclick = () => vote(idx);
        optionsEl.appendChild(div);
      });

      listenResults();
    }

    function vote(index) {
      const qKey = `q${current}`;
      const option = questions[current].options[index];
      const voteRef = ref(db, `votes/${qKey}/${option}`);
      update(voteRef, { ".value": increment(1) });

      document.querySelectorAll(".option").forEach((el) => {
        el.classList.add("disabled");
        if (el.textContent === option) {
          el.style.background = "#a5f3fc";
        }
      });

      nextBtn.style.display = current < questions.length - 1 ? "inline-block" : "none";
    }

    function listenResults() {
      const qKey = `q${current}`;
      const qRef = ref(db, `votes/${qKey}`);
      onValue(qRef, (snapshot) => {
        const data = snapshot.val() || {};
        const total = Object.values(data).reduce((a, b) => a + b, 0);
        document.querySelectorAll(".option").forEach((el) => {
          const count = data[el.textContent] || 0;
          const percent = total ? Math.round((count / total) * 100) : 0;

          // Agrega barra si no existe
          let bar = el.querySelector(".bar");
          if (!bar) {
            const container = document.createElement("div");
            container.className = "bar-container";
            bar = document.createElement("div");
            bar.className = "bar";
            container.appendChild(bar);
            el.appendChild(container);
          }
          bar.style.width = `${percent}%`;
        });
      });
    }

    nextBtn.onclick = () => {
      current++;
      if (current < questions.length) {
        loadQuestion();
      } else {
        questionEl.textContent = "Â¡Gracias por responder!";
        optionsEl.innerHTML = "";
        nextBtn.style.display = "none";
      }
    };

    loadQuestion();
  </script>
</body>
</html>
